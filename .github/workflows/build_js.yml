name: Build JS Sources

on:
  push:
    branches:
      - master
    paths:
      - 'sources/**/build.gradle.kts'
      - 'js-sources/**'
      - 'common/**'
      - 'annotations/**'
      - 'compiler/**'
  workflow_dispatch:  # Allow manual trigger

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build_js:
    name: Build JS Sources for iOS
    runs-on: ubuntu-latest
    env:
      CI_MODULE_GEN: true
    steps:
      - name: Clone repo
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: adopt

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Copy CI gradle.properties
        run: |
          mkdir -p ~/.gradle
          cp .github/runner-files/ci-gradle.properties ~/.gradle/gradle.properties

      - name: Run KSP for all JS-enabled sources
        run: |
          # Build list of all KSP tasks for JS-enabled sources
          KSP_TASKS=""
          
          # Find all sources with enableJs = true
          for BUILD_FILE in $(grep -rl "enableJs\s*=\s*true" sources/ 2>/dev/null || true); do
            DIR=$(dirname "$BUILD_FILE")
            NAME=$(basename "$DIR")
            PARENT=$(basename "$(dirname "$DIR")")
            
            # Skip if parent is 'sources' (multisrc case) or if it's the multisrc folder itself
            if [ "$PARENT" = "sources" ] || [ "$PARENT" = "multisrc" ]; then
              continue
            fi
            
            # LANG is the parent folder (e.g., 'en', 'ar')
            LANG="$PARENT"
            
            # Capitalize first letter of lang for task name
            LANG_CAP="$(echo ${LANG:0:1} | tr '[:lower:]' '[:upper:]')${LANG:1}"
            
            TASK=":extensions:individual:$LANG:$NAME:ksp${LANG_CAP}ReleaseKotlin"
            KSP_TASKS="$KSP_TASKS $TASK"
            echo "Found JS source: $NAME ($LANG)"
          done
          
          if [ -n "$KSP_TASKS" ]; then
            echo "Running all KSP tasks in single Gradle invocation..."
            ./gradlew $KSP_TASKS --parallel || true
          else
            echo "No JS-enabled sources found"
          fi

      - name: Build JS bundle
        run: |
          ./gradlew :js-sources:jsBrowserProductionWebpack :js-sources:createSourceIndex --parallel

      - name: Upload JS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: js-sources
          path: |
            js-sources/build/js-dist/
            js-sources/build/kotlin-webpack/js/productionExecutable/
          retention-days: 7

      - name: Checkout repo branch
        uses: actions/checkout@v4
        with:
          ref: repov2
          path: repo

      - name: Deploy JS to repo
        if: github.event_name == 'push' && github.repository == 'IReaderorg/IReader-extensions'
        run: |
          # Create js directory in repo
          mkdir -p repo/js
          
          # Copy JS bundle
          if [ -d "js-sources/build/kotlin-webpack/js/productionExecutable" ]; then
            cp js-sources/build/kotlin-webpack/js/productionExecutable/*.js repo/js/ 2>/dev/null || true
            cp js-sources/build/kotlin-webpack/js/productionExecutable/*.js.map repo/js/ 2>/dev/null || true
          fi
          
          # Copy JS index files (js-index.json and js-index.min.json)
          if [ -d "js-sources/build/js-dist" ]; then
            cp js-sources/build/js-dist/js-index.json repo/js/ 2>/dev/null || true
            cp js-sources/build/js-dist/js-index.min.json repo/js/ 2>/dev/null || true
          fi
          
          # List what we're deploying
          echo "JS files to deploy:"
          ls -la repo/js/ || true
          
          # Commit and push
          cd repo
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "Update JS sources"
            git push
          else
            echo "No JS changes to commit"
          fi
